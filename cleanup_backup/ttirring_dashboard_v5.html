<!doctype html>
<html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>띠링 — 대시보드 (v5: 조정 유형 필터)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f7f7f8;color:#111;margin:0}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr;gap:12px;align-items:end}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  .btn{background:#111;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-outline{background:#fff;color:#111;border:1px solid #d1d5db}
  .ipt{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:8px 10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  th.num, td.num{text-align:right}
  .muted{color:#6b7280;font-size:12px}
  .stat{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px;margin-top:12px}
  .stat .card{padding:12px}
  .stat .label{font-size:12px;color:#6b7280}
  .stat .value{font-size:18px;font-weight:700}
  .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .bar{height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden}
  .bar > div{height:10px;background:#111}
  .gauge{height:18px;background:#e5e7eb;border-radius:10px;overflow:hidden}
  .gauge > div{height:18px;background:#16a34a}
</style>
</head><body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0">띠링 — 대시보드 (v5)</h2>
  <div class="muted">KST 기준. 조정 유형(플랫폼/드라이버/전체/미포함) 선택 가능.</div>

  <div class="card" style="margin-top:16px">
    <div class="row">
      <label>Base URL
        <input id="baseUrl" class="ipt" value="http://127.0.0.1:3100" />
      </label>
      <label>From (KST)
        <input id="from" type="date" class="ipt" />
      </label>
      <label>To (KST)
        <input id="to" type="date" class="ipt" />
      </label>
      <label>채널 (비우면 전체)
        <input id="channelId" class="ipt" placeholder="예: CH-02" />
      </label>
      <label>Top N
        <input id="topN" class="ipt" type="number" value="10" min="1"/>
      </label>
      <label>조정 유형
        <select id="adjMode" class="ipt">
          <option value="all">전체(플랫폼+드라이버)</option>
          <option value="admin">플랫폼 수수료만</option>
          <option value="driver">드라이버만</option>
          <option value="none">미포함</option>
        </select>
      </label>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button id="btnSummary" class="btn">채널 요약</button>
      <button id="btnTop" class="btn btn-outline">Top Drivers</button>
      <button id="btnDaily" class="btn btn-outline">일별 요약</button>
      <button id="btnKpi" class="btn btn-outline">KPI</button>
    </div>
  </div>

  <div id="error" class="card" style="display:none; margin-top:12px; border-color:#fecaca; background:#fef2f2; color:#991b1b"></div>

  <!-- 채널 요약 -->
  <div class="card" style="margin-top:12px">
    <div class="sec-head">
      <div>
        <div style="font-weight:700">채널 요약</div>
        <div class="muted">/v1/reports/channel-summary + (ADMIN 지갑에서 플랫폼 수수료 분해)</div>
      </div>
      <button id="csvSummary" class="btn btn-outline" disabled>CSV 내보내기</button>
    </div>

    <div id="stats" class="stat" style="display:none">
      <div class="card"><div class="label">Jobs</div><div id="sJobs" class="value">-</div></div>
      <div class="card"><div class="label">Amount</div><div id="sAmt" class="value">-</div></div>
      <div class="card"><div class="label">Driver Payout</div><div id="sDrv" class="value">-</div></div>
      <div class="card"><div class="label">Platform Fee</div><div id="sFee" class="value">-</div></div>
      <div class="card"><div class="label">Wallet Adjustments(선택)</div><div id="sAdj" class="value">-</div></div>
      <div class="card"><div class="label">Net Amount(선택)</div><div id="sNet" class="value">-</div></div>
    </div>

    <div style="overflow:auto; margin-top:10px">
      <table id="tblSummary">
        <thead>
          <tr>
            <th>Channel</th>
            <th class="num">Amount</th>
            <th class="num">Driver</th>
            <th class="num">Fee</th>
            <th class="num">Wallet Adj(선택)</th>
            <th class="num">Net(선택)</th>
          </tr>
        </thead>
        <tbody id="rowsSummary"><tr><td colspan="6" class="muted">데이터 없음</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Top Drivers -->
  <div class="card" style="margin-top:12px">
    <div class="sec-head">
      <div>
        <div style="font-weight:700">Top Drivers</div>
        <div class="muted">/v1/reports/top-drivers</div>
      </div>
      <button id="csvTop" class="btn btn-outline" disabled>CSV 내보내기</button>
    </div>
    <div style="overflow:auto">
      <table id="tblTop">
        <thead>
          <tr>
            <th>Driver</th>
            <th class="num">Jobs</th>
            <th class="num">Amount</th>
            <th class="num">Driver Payout</th>
            <th class="num">Fee</th>
          </tr>
        </thead>
        <tbody id="rowsTop"><tr><td colspan="5" class="muted">데이터 없음</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- 일별 요약 -->
  <div class="card" style="margin-top:12px">
    <div class="sec-head">
      <div>
        <div style="font-weight:700">일별 요약</div>
        <div class="muted">/v1/reports/daily-summary</div>
      </div>
      <button id="csvDaily" class="btn btn-outline" disabled>CSV 내보내기</button>
    </div>
    <div style="overflow:auto">
      <table id="tblDaily">
        <thead>
          <tr>
            <th>Day</th>
            <th class="num">Jobs</th>
            <th class="num">Amount</th>
            <th class="num">Driver</th>
            <th class="num">Fee</th>
            <th style="width:220px">그래프</th>
          </tr>
        </thead>
        <tbody id="rowsDaily"><tr><td colspan="6" class="muted">데이터 없음</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- KPI -->
  <div class="card" style="margin-top:12px">
    <div class="sec-head">
      <div>
        <div style="font-weight:700">KPI</div>
        <div class="muted">/v1/reports/kpis</div>
      </div>
      <button id="csvKpi" class="btn btn-outline" disabled>CSV 내보내기</button>
    </div>

    <div class="stat" style="grid-template-columns:repeat(5,minmax(0,1fr))">
      <div class="card"><div class="label">Jobs</div><div id="kJobs" class="value">-</div></div>
      <div class="card"><div class="label">Amount</div><div id="kAmt" class="value">-</div></div>
      <div class="card"><div class="label">Driver Payout</div><div id="kDrv" class="value">-</div></div>
      <div class="card"><div class="label">Platform Fee</div><div id="kFee" class="value">-</div></div>
      <div class="card"><div class="label">Avg Job Amount</div><div id="kAvg" class="value">-</div></div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="label">Gross Margin %</div>
      <div id="kGmText" style="font-weight:700;margin:6px 0">-</div>
      <div class="gauge"><div id="kGmBar" style="width:0%"></div></div>
    </div>
  </div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);
  function setDefaultDates(){
    const now = new Date();
    const d2 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const d0 = new Date(d2.getTime() - 2*24*3600*1000);
    $('from').value = d0.toISOString().slice(0,10);
    $('to').value   = d2.toISOString().slice(0,10);
  }
  function kstIso(day,end=false){ if(!day) return null; return day + (end?'T23:59:59+09:00':'T00:00:00+09:00'); }
  function fmt(n){ return Number(n||0).toLocaleString('ko-KR'); }
  function showErr(e){ $('error').style.display='block'; $('error').textContent='오류: ' + (e.message||e); }

  function baseAndQuery(){
    const base = $('baseUrl').value.replace(/\/$/,'');
    const qs = new URLSearchParams();
    qs.set('from', kstIso($('from').value,false));
    qs.set('to',   kstIso($('to').value,true));
    const ch = $('channelId').value.trim();
    if (ch) qs.set('channelId', ch);
    return { base, qs, ch };
  }

  function downloadCsv(filename, rows){
    if(!rows.length) return;
    const headers = Object.keys(rows[0]||{});
    const esc = (v)=>String(v??'').replaceAll('"','""');
    const body = [headers.join(',')].concat(rows.map(r=>headers.map(h=>`"${esc(r[h])}"`).join(','))).join('\\n');
    const blob = new Blob(["\\ufeff"+body], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
  }

  // ADMIN 지갑에서 플랫폼 수수료 합계(채널별) 수집 (페이지네이션)
  async function fetchAdminPlatformFeesByChannel(base, fromIso, toIso, chFilter){
    let page = 1, size = 100, pages = 1, acc = [];
    do{
      const url = base + '/v1/wallet_tx?' + new URLSearchParams({userId:'ADMIN', page:String(page), size:String(size)}).toString();
      const r = await fetch(url); if(!r.ok) throw new Error('ADMIN wallet HTTP '+r.status);
      const j = await r.json();
      pages = Number(j?.pages||1);
      acc = acc.concat(j?.tx||[]);
      page++;
    }while(page<=pages);

    const from = new Date(fromIso), to = new Date(toIso);
    const byCh = {};
    for(const t of acc){
      if((t.reason||'').toUpperCase()!=='PLATFORM_FEE') continue;
      if(chFilter && t.channelId !== chFilter) continue;
      const d = new Date(t.createdAt);
      if(d < from || d > to) continue;
      const k = t.channelId || 'UNKNOWN';
      byCh[k] = (byCh[k]||0) + Number(t.amount||0);
    }
    return byCh; // { CH-02: 12600, ... }
  }

  // 채널 요약 (조정 유형 반영)
  async function loadSummary(){
    try{
      $('error').style.display='none';
      $('csvSummary').disabled = true;
      $('rowsSummary').innerHTML = '<tr><td class="muted" colspan="6">로딩중…</td></tr>';
      $('stats').style.display='none';

      const { base, qs, ch } = baseAndQuery();
      const fromIso = qs.get('from'), toIso = qs.get('to');
      const adjMode = $('adjMode').value; // all/admin/driver/none

      // 서버 요약 (기본 + 전체조정값 포함)
      if (adjMode !== 'none') qs.set('includeAdjustments','true');
      const url = base + '/v1/reports/channel-summary?' + qs.toString();
      const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();

      // ADMIN 수수료 맵 (driver/ admin 분해 필요할 때만 조회)
      let adminMap = {};
      if (adjMode === 'admin' || adjMode === 'driver') {
        adminMap = await fetchAdminPlatformFeesByChannel(base, fromIso, toIso, ch || null);
      }

      // 표 렌더 + 합계 계산
      const list = j?.channels ?? [];
      const rows = [];
      let sumAmt=0, sumAdj=0, sumDrv=0, sumFee=0;
      $('rowsSummary').innerHTML = list.length ? '' : '<tr><td class="muted" colspan="6">데이터 없음</td></tr>';

      for(const c of list){
        const amount = Number(c.amount||0);
        const driver = Number(c.driverPayout||0);
        const fee    = Number(c.platformFee||0);
        const waBase = Number(c.walletAdjustments||0);     // 전체 조정(서버)
        const waAdmin= Number(adminMap[c.channelId]||0);   // ADMIN 수수료(클라)
        const waDriv = waBase - waAdmin;                   // 드라이버 조정

        let usedAdj = 0;
        if (adjMode==='all')   usedAdj = waBase;
        if (adjMode==='admin') usedAdj = waAdmin;
        if (adjMode==='driver')usedAdj = waDriv;
        if (adjMode==='none')  usedAdj = 0;

        const net = amount + usedAdj;

        sumAmt += amount; sumAdj += usedAdj; sumDrv += driver; sumFee += fee;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.channelId||''}</td>
          <td class="num">${fmt(amount)}</td>
          <td class="num">${fmt(driver)}</td>
          <td class="num">${fmt(fee)}</td>
          <td class="num">${fmt(usedAdj)}</td>
          <td class="num"><b>${fmt(net)}</b></td>
        `;
        $('rowsSummary').appendChild(tr);

        rows.push({
          channelId: c.channelId,
          amount, driverPayout: driver, platformFee: fee,
          walletAdjustments: usedAdj, netAmount: net
        });
      }

      // 상단 카드(선택된 모드로)
      $('stats').style.display='grid';
      $('sJobs').textContent = fmt(j?.totals?.jobs);
      $('sAmt').textContent  = fmt(sumAmt);
      $('sDrv').textContent  = fmt(sumDrv);
      $('sFee').textContent  = fmt(sumFee);
      $('sAdj').textContent  = fmt(sumAdj);
      $('sNet').textContent  = fmt(sumAmt + sumAdj);

      // CSV
      $('csvSummary').disabled = !(rows.length);
      $('csvSummary').onclick = ()=>{
        const nameMode = {all:'ALL',admin:'ADMIN',driver:'DRIVER',none:'NONE'}[adjMode];
        downloadCsv(`channel_summary_${ch||'ALL'}_${$('from').value}_to_${$('to').value}_KST_adj-${nameMode}.csv`, rows);
      };
    }catch(e){ showErr(e); }
  }

  // Top Drivers
  async function loadTop(){
    try{
      $('error').style.display='none';
      $('csvTop').disabled = true;
      $('rowsTop').innerHTML = '<tr><td class="muted" colspan="5">로딩중…</td></tr>';
      const { base, qs, ch } = baseAndQuery();
      const n = Math.max(1, Number($('topN').value||10));
      qs.set('limit', n);
      const url = base + '/v1/reports/top-drivers?' + qs.toString();
      const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      const list = j?.drivers ?? [];
      $('rowsTop').innerHTML = list.length ? '' : '<tr><td class="muted" colspan="5">데이터 없음</td></tr>';
      list.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.driverId||''}</td>
          <td class="num">${fmt(d.jobs)}</td>
          <td class="num">${fmt(d.amount)}</td>
          <td class="num">${fmt(d.driverPayout)}</td>
          <td class="num">${fmt(d.platformFee)}</td>
        `;
        $('rowsTop').appendChild(tr);
      });

      $('csvTop').disabled = !(list.length);
      $('csvTop').onclick = ()=>{
        const rows = list.map(d=>({driverId:d.driverId, jobs:d.jobs, amount:d.amount, driverPayout:d.driverPayout, platformFee:d.platformFee}));
        downloadCsv(`top_drivers_${ch||'ALL'}_${$('from').value}_to_${$('to').value}_KST_top${n}.csv`, rows);
      };
    }catch(e){ showErr(e); }
  }

  // 일별 요약
  async function loadDaily(){
    try{
      $('error').style.display='none';
      $('csvDaily').disabled = true;
      $('rowsDaily').innerHTML = '<tr><td class="muted" colspan="6">로딩중…</td></tr>';
      const { base, qs, ch } = baseAndQuery();
      const url = base + '/v1/reports/daily-summary?' + qs.toString();
      const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      const list = j?.series ?? [];
      $('rowsDaily').innerHTML = list.length ? '' : '<tr><td class="muted" colspan="6">데이터 없음</td></tr>';

      const maxAmt = Math.max(...list.map(x=>Number(x.amount||0)), 1);
      list.forEach(d=>{
        const w = Math.round((Number(d.amount||0) / maxAmt) * 100);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.day||''}</td>
          <td class="num">${fmt(d.jobs)}</td>
          <td class="num">${fmt(d.amount)}</td>
          <td class="num">${fmt(d.driverPayout)}</td>
          <td class="num">${fmt(d.platformFee)}</td>
          <td><div class="bar"><div style="width:${w}%"></div></div></td>
        `;
        $('rowsDaily').appendChild(tr);
      });

      $('csvDaily').disabled = !(list.length);
      $('csvDaily').onclick = ()=>{
        const rows = list.map(d=>({day:d.day, jobs:d.jobs, amount:d.amount, driverPayout:d.driverPayout, platformFee:d.platformFee}));
        downloadCsv(`daily_summary_${ch||'ALL'}_${$('from').value}_to_${$('to').value}_KST.csv`, rows);
      };
    }catch(e){ showErr(e); }
  }

  // KPI
  async function loadKpi(){
    try{
      $('error').style.display='none';
      $('csvKpi').disabled = true;
      const { base, qs, ch } = baseAndQuery();
      const url = base + '/v1/reports/kpis?' + qs.toString();
      const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      const t = j?.totals || {}; const k = j?.kpis || {};
      $('kJobs').textContent = fmt(t.jobs);
      $('kAmt').textContent  = fmt(t.amount);
      $('kDrv').textContent  = fmt(t.driverPayout);
      $('kFee').textContent  = fmt(t.platformFee);
      $('kAvg').textContent  = fmt(k.avgJobAmount);
      const gm = Number(k.grossMarginPct||0);
      $('kGmText').textContent = gm.toLocaleString('ko-KR',{maximumFractionDigits:2}) + ' %';
      $('kGmBar').style.width = Math.max(0, Math.min(100, gm)) + '%';

      $('csvKpi').disabled = false;
      $('csvKpi').onclick = ()=>{
        const rows = [{channelId: ch||'ALL', jobs:t.jobs, amount:t.amount, driverPayout:t.driverPayout, platformFee:t.platformFee, avgJobAmount:k.avgJobAmount, grossMarginPct:k.grossMarginPct}];
        downloadCsv(`kpis_${ch||'ALL'}_${$('from').value}_to_${$('to').value}_KST.csv`, rows);
      };
    }catch(e){ showErr(e); }
  }

  document.getElementById('btnSummary').addEventListener('click', loadSummary);
  document.getElementById('btnTop').addEventListener('click', loadTop);
  document.getElementById('btnDaily').addEventListener('click', loadDaily);
  document.getElementById('btnKpi').addEventListener('click', loadKpi);
  setDefaultDates();
</script>
</body></html>
